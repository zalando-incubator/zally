package de.zalando.zally.rule

import com.typesafe.config.Config
import de.zalando.zally.dto.ViolationType
import de.zalando.zally.util.getAllJsonObjects
import io.swagger.models.Swagger
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.actuate.metrics.dropwizard.DropwizardMetricServices
import org.springframework.stereotype.Component

@Component
class AvoidSynonymsRule(
    @Autowired rulesConfig: Config, @Autowired metricServices: DropwizardMetricServices) : SwaggerRule() {

    override val title = "Use common property names"
    override val url = "/#174"
    override val violationType = ViolationType.MUST
    override val code = "S010"
    override val guidelinesCode = "174"

    private val descPattern = "Property names should utilize common dictionary"
    private val metricServices = metricServices

    @Suppress("UNCHECKED_CAST")
    private val commonDictionary = rulesConfig.getConfig("$name.dictionary").entrySet()
        .map { (key, config) -> key to config.unwrapped() as List<String> }

    override fun validate(swagger: Swagger): Violation? {
        return validate(swagger, false)
    }

    fun validate(swagger: Swagger, returnViolation: Boolean): Violation? {
        val reversedDictionary = commonDictionary.flatMap { (canonical, synonyms) -> synonyms.map { it to canonical } }.toMap()
        val result = swagger.getAllJsonObjects().flatMap { (def, path) ->
            def.keys.filter { it in reversedDictionary }.map { it to path }
        }

        if (result.isEmpty()) {
            return null
        }

        val (names, paths) = result.unzip()
        submitStatistics(names)

        // TODO: Start returning violations once we'll define a proper dictionary (#301)
        return if (returnViolation) {
            val details = names.toSet().groupBy(reversedDictionary::get)
                .map { (canonical, synonyms) -> canonical + " instead of " + synonyms.joinToString(", ") }
                .joinToString("\n")
            val distinctPaths = paths.toSet().toList()
            Violation(this, title, "$descPattern:\n$details", violationType, url, distinctPaths)
        } else {
            null
        }
    }

    fun submitStatistics(names: List<String>) {
        names.groupBy { it }.map {
            metricServices.submit(
                "histogram.rules.avoid-synonyms.synonym." + it.key, it.value.count().toDouble()
            )
        }
    }
}
